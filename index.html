<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Todo App</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      background: #f0f2f5;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 48px 16px;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    /* ‚îÄ‚îÄ Kart ‚îÄ‚îÄ */
    .card {
      background: #fff;
      width: 100%;
      max-width: 480px;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,.10);
      padding: 32px;
    }

    h1 { font-size: 1.6rem; font-weight: 700; color: #1a1a2e; letter-spacing: -.5px; }
    h2 { font-size: 1.2rem; font-weight: 700; color: #1a1a2e; margin-bottom: 20px; text-align: center; }

    /* ‚îÄ‚îÄ Auth ekranƒ± ‚îÄ‚îÄ */
    #auth-screen  { display: flex; flex-direction: column; gap: 20px; }
    #app-screen   { display: none; }
    #confirm-screen { display: none; text-align: center; padding: 12px 0; }

    .tab-row {
      display: flex;
      border: 2px solid #e2e5ea;
      border-radius: 10px;
      overflow: hidden;
    }

    .tab-row button {
      flex: 1;
      padding: 9px;
      border: none;
      background: transparent;
      font-size: 0.88rem;
      font-weight: 600;
      color: #999;
      cursor: pointer;
      transition: all .2s;
    }

    .tab-row button.active {
      background: #6c63ff;
      color: #fff;
    }

    .form-group { display: flex; flex-direction: column; gap: 6px; }

    .form-group label { font-size: 0.82rem; font-weight: 600; color: #555; }

    .form-group input {
      padding: 10px 14px;
      border: 2px solid #e2e5ea;
      border-radius: 10px;
      font-size: 0.93rem;
      outline: none;
      transition: border-color .2s;
    }

    .form-group input:focus { border-color: #6c63ff; }

    .auth-btn {
      width: 100%;
      padding: 11px;
      background: #6c63ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: background .2s;
    }

    .auth-btn:hover { background: #574fd6; }
    .auth-btn:disabled { background: #b0acf5; cursor: not-allowed; }

    .remember-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: #555;
      cursor: pointer;
      user-select: none;
    }

    .remember-row input[type="checkbox"] {
      width: 16px; height: 16px;
      accent-color: #6c63ff;
      cursor: pointer;
      flex-shrink: 0;
    }

    .refresh-btn {
      padding: 10px 14px;
      background: #f0effe;
      color: #6c63ff;
      border: 2px solid #6c63ff;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: background .2s, transform .2s;
      flex-shrink: 0;
    }

    .refresh-btn:hover  { background: #e0d9fd; }
    .refresh-btn.spin   { animation: spin .6s linear; }

    .auth-error {
      font-size: 0.82rem;
      color: #e74c3c;
      text-align: center;
      min-height: 18px;
    }

    /* ‚îÄ‚îÄ Onay ekranƒ± ‚îÄ‚îÄ */
    .confirm-icon { font-size: 3rem; margin-bottom: 12px; }
    .confirm-title { font-size: 1.1rem; font-weight: 700; color: #1a1a2e; margin-bottom: 8px; }
    .confirm-sub   { font-size: 0.88rem; color: #888; line-height: 1.6; }
    .confirm-email { font-weight: 700; color: #6c63ff; }
    .back-link {
      margin-top: 16px;
      display: inline-block;
      font-size: 0.82rem;
      color: #6c63ff;
      cursor: pointer;
      text-decoration: underline;
    }

    /* ‚îÄ‚îÄ App ekranƒ± ‚îÄ‚îÄ */
    .app-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .user-info { font-size: 0.78rem; color: #999; margin-top: 4px; }

    .logout-btn {
      background: none;
      border: 2px solid #e2e5ea;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: 600;
      color: #888;
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }

    .logout-btn:hover { border-color: #e74c3c; color: #e74c3c; }

    /* ‚îÄ‚îÄ Input satƒ±rƒ± ‚îÄ‚îÄ */
    .input-row { display: flex; gap: 8px; margin-bottom: 24px; }

    .input-row input {
      flex: 1;
      padding: 10px 14px;
      border: 2px solid #e2e5ea;
      border-radius: 10px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color .2s;
    }

    .input-row input:focus { border-color: #6c63ff; }

    .input-row button {
      padding: 10px 18px;
      background: #6c63ff;
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 1.3rem;
      cursor: pointer;
      transition: background .2s, transform .1s;
    }

    .input-row button:hover  { background: #574fd6; }
    .input-row button:active { transform: scale(.95); }

    /* ‚îÄ‚îÄ Filtreler ‚îÄ‚îÄ */
    .filters { display: flex; gap: 6px; margin-bottom: 18px; }

    .filters button {
      flex: 1;
      padding: 7px;
      border: 2px solid #e2e5ea;
      background: transparent;
      border-radius: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      color: #666;
      transition: all .2s;
    }

    .filters button.active {
      border-color: #6c63ff;
      color: #6c63ff;
      background: #f0effe;
    }

    /* ‚îÄ‚îÄ Liste ‚îÄ‚îÄ */
    ul {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 60px;
    }

    li {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 10px;
      background: #f8f9fb;
      border: 1px solid #eceef2;
      animation: fadeIn .2s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-6px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    li.done .label { text-decoration: line-through; color: #aaa; }

    li input[type="checkbox"] {
      width: 18px; height: 18px;
      accent-color: #6c63ff;
      cursor: pointer;
      flex-shrink: 0;
    }

    .label {
      flex: 1;
      font-size: 0.93rem;
      color: #333;
      word-break: break-word;
    }

    .icon-btn {
      background: none;
      border: none;
      font-size: 1.05rem;
      cursor: pointer;
      color: #ccc;
      transition: color .2s;
      flex-shrink: 0;
      line-height: 1;
      padding: 2px;
    }

    .edit-btn:hover { color: #6c63ff; }
    .del-btn:hover  { color: #e74c3c; }

    li.editing { background: #f0effe; border-color: #6c63ff; }

    .edit-input {
      flex: 1;
      padding: 4px 8px;
      border: 2px solid #6c63ff;
      border-radius: 6px;
      font-size: 0.93rem;
      outline: none;
      background: #fff;
    }

    .save-btn {
      background: #6c63ff;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 4px 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      flex-shrink: 0;
    }

    .save-btn:hover { background: #574fd6; }

    .empty { text-align: center; color: #bbb; font-size: .88rem; padding: 24px 0; }

    /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
    .footer {
      margin-top: 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.82rem;
      color: #999;
    }

    .clear-btn {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 0.82rem;
      cursor: pointer;
      font-weight: 600;
    }

    .clear-btn:hover { text-decoration: underline; }

    /* ‚îÄ‚îÄ Spinner ‚îÄ‚îÄ */
    .spinner { display: flex; justify-content: center; padding: 24px 0; }

    .spinner::after {
      content: '';
      width: 24px; height: 24px;
      border: 3px solid #e2e5ea;
      border-top-color: #6c63ff;
      border-radius: 50%;
      animation: spin .6s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
    .toast {
      position: fixed;
      bottom: 24px; left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 0.85rem;
      opacity: 0;
      transition: opacity .3s;
      pointer-events: none;
      z-index: 999;
      white-space: nowrap;
    }

    .toast.show { opacity: 1; }
    .toast.error { background: #e74c3c; }

    /* ‚îÄ‚îÄ G√∂rev ekleme meta satƒ±rƒ± ‚îÄ‚îÄ */
    .add-meta {
      display: flex;
      gap: 8px;
      margin-top: -16px;
      margin-bottom: 20px;
    }

    .priority-select, .date-input {
      flex: 1;
      padding: 8px 10px;
      border: 2px solid #e2e5ea;
      border-radius: 10px;
      font-size: 0.85rem;
      outline: none;
      background: #fff;
      color: #444;
      cursor: pointer;
      transition: border-color .2s;
      appearance: none;
      -webkit-appearance: none;
    }

    .priority-select:focus, .date-input:focus { border-color: #6c63ff; }

    /* ‚îÄ‚îÄ √ñncelik renkleri (select border) ‚îÄ‚îÄ */
    .priority-select.acil   { border-color: #7b1c2e; color: #7b1c2e; }
    .priority-select.onemli { border-color: #6c63ff; color: #6c63ff; }
    .priority-select.genel  { border-color: #2e7d52; color: #2e7d52; }

    /* ‚îÄ‚îÄ Liste √∂ƒüesi i√ßi ‚îÄ‚îÄ */
    li { align-items: flex-start; }

    li input[type="checkbox"] { margin-top: 2px; }

    .task-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 0;
    }

    .task-label {
      font-size: 0.93rem;
      color: #333;
      word-break: break-word;
    }

    li.done .task-label { text-decoration: line-through; color: #aaa; }

    .deadline-text {
      font-size: 0.75rem;
      color: #aaa;
    }

    .deadline-text.overdue { color: #e74c3c; font-weight: 600; }
    .deadline-text.today   { color: #f39c12; font-weight: 600; }

    /* ‚îÄ‚îÄ √ñncelik rozeti ‚îÄ‚îÄ */
    .badge {
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 20px;
      flex-shrink: 0;
      margin-top: 1px;
      text-transform: uppercase;
      letter-spacing: .4px;
    }

    .badge.acil   { background: #f5e0e4; color: #7b1c2e; }
    .badge.onemli { background: #eeecff; color: #4b44c4; }
    .badge.genel  { background: #e0f5ec; color: #2e7d52; }

    /* Sol kenar renk ≈üeridi */
    li.p-acil   { border-left: 3px solid #7b1c2e; }
    li.p-onemli { border-left: 3px solid #6c63ff; }
    li.p-genel  { border-left: 3px solid #2e7d52; }

    /* D√ºzenleme modunda ek alanlar */
    .edit-meta {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .edit-priority, .edit-date {
      flex: 1;
      padding: 4px 8px;
      border: 2px solid #6c63ff;
      border-radius: 6px;
      font-size: 0.82rem;
      outline: none;
      background: #fff;
    }
  </style>
</head>
<body>
<div class="card">

  <!-- AUTH EKRANI -->
  <div id="auth-screen">
    <h2>Yapƒ±lacaklar</h2>

    <div class="tab-row">
      <button id="tab-login" class="active" onclick="switchTab('login')">Giri≈ü Yap</button>
      <button id="tab-register"               onclick="switchTab('register')">Kayƒ±t Ol</button>
    </div>

    <div class="form-group">
      <label for="auth-email">E-posta</label>
      <input id="auth-email" type="email" placeholder="ornek@mail.com" autocomplete="email" />
    </div>

    <div class="form-group">
      <label for="auth-pass">≈ûifre</label>
      <input id="auth-pass" type="password" placeholder="En az 6 karakter" autocomplete="current-password" />
    </div>

    <label class="remember-row" id="remember-row">
      <input type="checkbox" id="rememberMe" checked />
      Beni hatƒ±rla
    </label>

    <p class="auth-error" id="auth-error"></p>

    <button class="auth-btn" id="auth-submit">Giri≈ü Yap</button>
  </div>

  <!-- ONAY BEKLENƒ∞YOR -->
  <div id="confirm-screen">
    <div class="confirm-icon">üì¨</div>
    <div class="confirm-title">E-postanƒ± onayla</div>
    <p class="confirm-sub">
      <span class="confirm-email" id="confirm-email-text"></span> adresine
      bir onay baƒülantƒ±sƒ± g√∂nderdik.<br/>
      L√ºtfen gelen kutunu kontrol et ve baƒülantƒ±ya tƒ±kla.
    </p>
    <span class="back-link" onclick="showScreen('auth')">‚Üê Giri≈ü ekranƒ±na d√∂n</span>
  </div>

  <!-- UYGULAMA -->
  <div id="app-screen">
    <div class="app-header">
      <div>
        <h1>Yapƒ±lacaklar</h1>
        <div class="user-info" id="user-email"></div>
      </div>
      <button class="logout-btn" id="logoutBtn">√áƒ±kƒ±≈ü</button>
    </div>

    <div class="input-row">
      <input id="newTask" type="text" placeholder="Yeni g√∂rev ekle..." maxlength="120" />
      <button id="refreshBtn" class="refresh-btn" title="Yenile">&#x21BB;</button>
      <button id="addBtn">+</button>
    </div>

    <div class="add-meta">
      <select id="newPriority" class="priority-select genel">
        <option value="genel">‚óè Genel</option>
        <option value="onemli">‚óè √ñnemli</option>
        <option value="acil">‚óè Acil</option>
      </select>
      <input id="newDeadline" type="date" class="date-input" />
    </div>

    <div class="filters">
      <button class="active" data-filter="all">T√ºm√º</button>
      <button data-filter="active">Bekleyen</button>
      <button data-filter="done">Tamamlanan</button>
    </div>

    <ul id="list"></ul>

    <div class="footer">
      <span id="counter"></span>
      <button class="clear-btn" id="clearDone">Tamamlananlarƒ± sil</button>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
  const SUPABASE_URL  = 'https://sdaslqmjfgtnylpyegao.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNkYXNscW1qZmd0bnlscHllZ2FvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MTk4NDIsImV4cCI6MjA4NzE5NTg0Mn0.FIkLhE1vp8BU2v7tWnofDK71bKtIOvJMo_MGimKxc_E';

  const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
    auth: { detectSessionInUrl: true }
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     EKRAN Y√ñNETƒ∞Mƒ∞
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  function showScreen(name) {
    document.getElementById('auth-screen').style.display    = name === 'auth'    ? 'flex' : 'none';
    document.getElementById('confirm-screen').style.display = name === 'confirm' ? 'block' : 'none';
    document.getElementById('app-screen').style.display     = name === 'app'     ? 'block' : 'none';
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH: SEKME
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  let currentTab = 'login';

  function switchTab(tab) {
    currentTab = tab;
    document.getElementById('tab-login').classList.toggle('active', tab === 'login');
    document.getElementById('tab-register').classList.toggle('active', tab === 'register');
    document.getElementById('auth-submit').textContent = tab === 'login' ? 'Giri≈ü Yap' : 'Kayƒ±t Ol';
    document.getElementById('auth-error').textContent  = '';
    document.getElementById('auth-pass').autocomplete  = tab === 'login' ? 'current-password' : 'new-password';
    // "Beni hatƒ±rla" sadece giri≈ü ekranƒ±nda g√∂ster
    document.getElementById('remember-row').style.display = tab === 'login' ? 'flex' : 'none';
  }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH: Gƒ∞Rƒ∞≈û / KAYIT
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  document.getElementById('auth-submit').addEventListener('click', async () => {
    const email = document.getElementById('auth-email').value.trim();
    const pass  = document.getElementById('auth-pass').value;
    const errEl = document.getElementById('auth-error');
    const btn   = document.getElementById('auth-submit');

    errEl.textContent = '';
    if (!email || !pass) { errEl.textContent = 'E-posta ve ≈üifre gerekli.'; return; }

    btn.disabled = true;
    btn.textContent = '...';

    if (currentTab === 'login') {
      const remember = document.getElementById('rememberMe').checked;
      localStorage.setItem('rememberMe', remember ? '1' : '0');

      const { error } = await db.auth.signInWithPassword({ email, password: pass });
      if (error) {
        errEl.textContent = error.message === 'Invalid login credentials'
          ? 'E-posta veya ≈üifre hatalƒ±.'
          : error.message === 'Email not confirmed'
          ? 'E-postanƒ± hen√ºz onaylamamƒ±≈üsƒ±n.'
          : error.message;
      } else {
        // "Beni hatƒ±rla" i≈üaretli deƒüilse sekme kapanƒ±nca oturumu kapat
        if (!remember) {
          window.addEventListener('beforeunload', () => db.auth.signOut());
        }
      }
    } else {
      const { error } = await db.auth.signUp({
        email,
        password: pass,
        options: { emailRedirectTo: 'https://todo-app-3on.pages.dev' }
      });
      if (error) {
        errEl.textContent = error.message;
      } else {
        document.getElementById('confirm-email-text').textContent = email;
        showScreen('confirm');
      }
    }

    btn.disabled = false;
    switchTab(currentTab); // butonu sƒ±fƒ±rla
  });

  // Enter ile g√∂nder
  ['auth-email','auth-pass'].forEach(id => {
    document.getElementById(id).addEventListener('keydown', e => {
      if (e.key === 'Enter') document.getElementById('auth-submit').click();
    });
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     AUTH STATE DEƒûƒ∞≈ûƒ∞KLƒ∞ƒûƒ∞
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  let currentUser = null;

  db.auth.onAuthStateChange(async (event, session) => {
    if (session) {
      // Sayfa y√ºklendiƒüinde "beni hatƒ±rla" kapalƒ±ysa oturumu temizle
      if (event === 'INITIAL_SESSION' && localStorage.getItem('rememberMe') === '0') {
        await db.auth.signOut();
        return;
      }
      currentUser = session.user;
      document.getElementById('user-email').textContent = session.user.email;
      if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
        showScreen('app');
        await loadTasks();
      }
    } else {
      currentUser = null;
      tasks = [];
      showScreen('auth');
    }
  });

  document.getElementById('logoutBtn').addEventListener('click', async () => {
    await db.auth.signOut();
  });

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     TODO UYGULAMASI
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  let tasks  = [];
  let filter = 'all';

  const taskInput    = document.getElementById('newTask');
  const prioritySel  = document.getElementById('newPriority');
  const deadlineInp  = document.getElementById('newDeadline');
  const list         = document.getElementById('list');
  const counter      = document.getElementById('counter');
  const filterBtns   = document.querySelectorAll('.filters button');

  // Priority select rengi deƒüi≈ütir
  prioritySel.addEventListener('change', () => {
    prioritySel.className = 'priority-select ' + prioritySel.value;
  });

  // Bug√ºn√ºn tarihini min deƒüer olarak ayarla
  deadlineInp.min = new Date().toISOString().split('T')[0];

  function showToast(msg, type = '') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.className = 'toast show' + (type ? ' ' + type : '');
    setTimeout(() => t.classList.remove('show'), 3000);
  }

  function escHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  const PRIORITY_LABEL = { acil: 'Acil', onemli: '√ñnemli', genel: 'Genel' };

  function formatDeadline(dateStr) {
    if (!dateStr) return null;
    const today    = new Date(); today.setHours(0,0,0,0);
    const deadline = new Date(dateStr + 'T00:00:00');
    const diff     = Math.round((deadline - today) / 86400000);
    const label    = deadline.toLocaleDateString('tr-TR', { day:'numeric', month:'short', year:'numeric' });
    if (diff < 0)  return { text: `Ge√ßti: ${label}`, cls: 'overdue' };
    if (diff === 0) return { text: `Bug√ºn son g√ºn`, cls: 'today' };
    if (diff === 1) return { text: `Yarƒ±n son g√ºn`, cls: '' };
    return { text: `Son: ${label}`, cls: '' };
  }

  function render() {
    const visible = tasks.filter(t =>
      filter === 'all'    ? true :
      filter === 'active' ? !t.done : t.done
    );

    list.innerHTML = '';

    if (visible.length === 0) {
      list.innerHTML = '<p class="empty">G√∂rev yok.</p>';
    } else {
      visible.forEach(t => {
        const p   = t.priority || 'genel';
        const dl  = formatDeadline(t.deadline);
        const li  = document.createElement('li');
        li.classList.add('p-' + p);
        if (t.done) li.classList.add('done');
        li.innerHTML = `
          <input type="checkbox" ${t.done ? 'checked' : ''} data-id="${t.id}" />
          <div class="task-body">
            <span class="task-label">${escHtml(t.text)}</span>
            ${dl ? `<span class="deadline-text ${dl.cls}">${dl.text}</span>` : ''}
          </div>
          <span class="badge ${p}">${PRIORITY_LABEL[p]}</span>
          <button class="icon-btn edit-btn" data-id="${t.id}" title="D√ºzenle">&#x270E;</button>
          <button class="icon-btn del-btn"  data-id="${t.id}" title="Sil">&#x2715;</button>
        `;
        list.appendChild(li);
      });
    }

    const pending = tasks.filter(t => !t.done).length;
    counter.textContent = `${pending} g√∂rev bekliyor`;
  }

  async function loadTasks() {
    list.innerHTML = '<div class="spinner"></div>';
    const { data, error } = await db
      .from('todos')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) { showToast('Veriler y√ºklenemedi.', 'error'); return; }
    tasks = data;
    render();
  }

  async function addTask() {
    const text     = taskInput.value.trim();
    if (!text || !currentUser) return;
    const priority = prioritySel.value;
    const deadline = deadlineInp.value || null;
    taskInput.value   = '';
    deadlineInp.value = '';
    prioritySel.value = 'genel';
    prioritySel.className = 'priority-select genel';

    const { data, error } = await db
      .from('todos')
      .insert({ text, done: false, priority, deadline, user_id: currentUser.id })
      .select()
      .single();

    if (error) { showToast('G√∂rev eklenemedi: ' + error.message, 'error'); return; }
    tasks.unshift(data);
    render();
  }

  document.getElementById('addBtn').addEventListener('click', addTask);
  taskInput.addEventListener('keydown', e => { if (e.key === 'Enter') addTask(); });

  document.getElementById('refreshBtn').addEventListener('click', async () => {
    const btn = document.getElementById('refreshBtn');
    btn.classList.add('spin');
    await loadTasks();
    setTimeout(() => btn.classList.remove('spin'), 600);
  });

  list.addEventListener('change', async e => {
    if (e.target.type !== 'checkbox') return;
    const id   = +e.target.dataset.id;
    const done = e.target.checked;
    const { error } = await db.from('todos').update({ done }).eq('id', id);
    if (error) { showToast('G√ºncellenemedi.', 'error'); return; }
    const t = tasks.find(t => t.id === id);
    if (t) t.done = done;
    render();
  });

  list.addEventListener('click', async e => {
    if (e.target.classList.contains('del-btn')) {
      const id = +e.target.dataset.id;
      const { error } = await db.from('todos').delete().eq('id', id);
      if (error) { showToast('Silinemedi.', 'error'); return; }
      tasks = tasks.filter(t => t.id !== id);
      render();
      return;
    }

    if (e.target.classList.contains('edit-btn')) {
      const id = +e.target.dataset.id;
      const t  = tasks.find(t => t.id === id);
      if (!t) return;
      const li = e.target.closest('li');
      li.classList.add('editing');
      li.innerHTML = `
        <input type="checkbox" ${t.done ? 'checked' : ''} data-id="${t.id}" />
        <div class="task-body">
          <input class="edit-input" type="text" value="${escHtml(t.text)}" maxlength="120" data-id="${t.id}" />
          <div class="edit-meta">
            <select class="edit-priority" data-id="${t.id}">
              <option value="genel"  ${t.priority==='genel'  ?'selected':''}>‚óè Genel</option>
              <option value="onemli" ${t.priority==='onemli' ?'selected':''}>‚óè √ñnemli</option>
              <option value="acil"   ${t.priority==='acil'   ?'selected':''}>‚óè Acil</option>
            </select>
            <input class="edit-date" type="date" value="${t.deadline||''}" data-id="${t.id}" />
          </div>
        </div>
        <button class="save-btn" data-id="${t.id}">Kaydet</button>
        <button class="icon-btn del-btn" data-id="${t.id}" title="Sil">&#x2715;</button>
      `;
      const ei = li.querySelector('.edit-input');
      ei.focus();
      ei.selectionStart = ei.selectionEnd = ei.value.length;
      ei.addEventListener('keydown', ev => {
        if (ev.key === 'Enter')  commitEdit(id, li);
        if (ev.key === 'Escape') render();
      });
      return;
    }

    if (e.target.classList.contains('save-btn')) {
      const li = e.target.closest('li');
      const id = +e.target.dataset.id;
      commitEdit(id, li);
    }
  });

  async function commitEdit(id, li) {
    const text     = li.querySelector('.edit-input').value.trim();
    const priority = li.querySelector('.edit-priority').value;
    const deadline = li.querySelector('.edit-date').value || null;
    if (!text) return;
    const { error } = await db.from('todos').update({ text, priority, deadline }).eq('id', id);
    if (error) { showToast('D√ºzenlenemedi.', 'error'); return; }
    const t = tasks.find(t => t.id === id);
    if (t) { t.text = text; t.priority = priority; t.deadline = deadline; }
    render();
  }

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      filter = btn.dataset.filter;
      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      render();
    });
  });

  document.getElementById('clearDone').addEventListener('click', async () => {
    const ids = tasks.filter(t => t.done).map(t => t.id);
    if (!ids.length) return;
    const { error } = await db.from('todos').delete().in('id', ids);
    if (error) { showToast('Silinemedi.', 'error'); return; }
    tasks = tasks.filter(t => !t.done);
    render();
  });
</script>
</body>
</html>
